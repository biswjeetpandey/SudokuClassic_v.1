<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sudoku Classic</title>
    <script src="react.development.js"></script>
    <script src="react-dom.development.js"></script>
    <script src="babel.min.js"></script>
    <script src="tailwindcss.min.js"></script>
    
    <style>
        /* Additional styling for better mobile experience */
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            touch-action: manipulation;
        }
        
        /* Prevent text selection on game elements */
        .sudoku-board button {
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }
        
        /* Custom focus styles for better accessibility */
        button:focus {
            outline: 2px solid #3b82f6;
            outline-offset: 2px;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect, useCallback } = React;
        
        // Storage keys
        const STORAGE_KEYS = {
            SAVED_GAME: 'sudokuSavedGame',
            BEST_TIMES: 'sudokuBestTimes',
            SETTINGS: 'sudokuSettings'
        };
        
        // Lucide Icons as React components
        const Play = ({ size = 24, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <polygon points="5,3 19,12 5,21"></polygon>
            </svg>
        );
        
        const RotateCcw = ({ size = 24, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <polyline points="1,4 1,10 7,10"></polyline>
                <path d="M3.51,15a9,9,0,0,0,2.13,3.09l.77-.77A8,8,0,0,1,4.14,12H2.1A10,10,0,0,1,3.51,15Z"></path>
            </svg>
        );
        
        const Lightbulb = ({ size = 24, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <path d="M9 21h6"></path>
                <path d="M12 17v4"></path>
                <path d="M12 3a5 5 0 0 1 5 5c0 2-1 3-2 4v2a1 1 0 0 1-1 1H10a1 1 0 0 1-1-1v-2c-1-1-2-2-2-4a5 5 0 0 1 5-5Z"></path>
            </svg>
        );
        
        const Trophy = ({ size = 24, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"></path>
                <path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"></path>
                <path d="M4 22h16"></path>
                <path d="M10 14.66V17c0 .55.47.98.97 1.21C11.25 18.74 11.61 19 12 19s.75-.26 1.03-.79c.5-.23.97-.66.97-1.21v-2.34"></path>
                <path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"></path>
            </svg>
        );
        
        const Clock = ({ size = 24, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <circle cx="12" cy="12" r="10"></circle>
                <polyline points="12,6 12,12 16,14"></polyline>
            </svg>
        );
        
        const Star = ({ size = 24, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <polygon points="12,2 15.09,8.26 22,9.27 17,14.14 18.18,21.02 12,17.77 5.82,21.02 7,14.14 2,9.27 8.91,8.26"></polygon>
            </svg>
        );
        
        const Settings = ({ size = 24, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <circle cx="12" cy="12" r="3"></circle>
                <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1 1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1Z"></path>
            </svg>
        );
        
        const Palette = ({ size = 24, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <circle cx="13.5" cy="6.5" r=".5"></circle>
                <circle cx="17.5" cy="10.5" r=".5"></circle>
                <circle cx="8.5" cy="7.5" r=".5"></circle>
                <circle cx="6.5" cy="12.5" r=".5"></circle>
                <path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c.926 0 1.648-.746 1.648-1.688 0-.437-.18-.835-.437-1.125-.29-.289-.438-.652-.438-1.125a1.64 1.64 0 0 1 1.668-1.668h1.996c3.051 0 5.555-2.503 5.555-5.554C21.965 6.012 17.461 2 12 2Z"></path>
            </svg>
        );
        
        const Volume2 = ({ size = 24, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <polygon points="11,5 6,9 2,9 2,15 6,15 11,19"></polygon>
                <path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path>
            </svg>
        );
        
        const VolumeX = ({ size = 24, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <polygon points="11,5 6,9 2,9 2,15 6,15 11,19"></polygon>
                <line x1="23" y1="9" x2="17" y2="15"></line>
                <line x1="17" y1="9" x2="23" y2="15"></line>
            </svg>
        );
        
        const Smartphone = ({ size = 24, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <rect x="5" y="2" width="14" height="20" rx="2" ry="2"></rect>
                <line x1="12" y1="18" x2="12.01" y2="18"></line>
            </svg>
        );

        const Trash2 = ({ size = 24, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <polyline points="3,6 5,6 21,6"></polyline>
                <path d="m19,6v14a2,2 0 0,1 -2,2H7a2,2 0 0,1 -2,-2V6m3,0V4a2,2 0 0,1 2,-2h4a2,2 0 0,1 2,2v2"></path>
                <line x1="10" y1="11" x2="10" y2="17"></line>
                <line x1="14" y1="11" x2="14" y2="17"></line>
            </svg>
        );

        // Storage utility functions
        const StorageManager = {
            // Save game state to localStorage
            saveGame: (gameData) => {
                try {
                    const dataToSave = {
                        ...gameData,
                        savedAt: Date.now(),
                        conflicts: Array.from(gameData.conflicts) // Convert Set to Array for JSON
                    };
                    localStorage.setItem(STORAGE_KEYS.SAVED_GAME, JSON.stringify(dataToSave));
                    return true;
                } catch (e) {
                    console.error('Error saving game:', e);
                    return false;
                }
            },

            // Load game state from localStorage
            loadGame: () => {
                try {
                    const saved = localStorage.getItem(STORAGE_KEYS.SAVED_GAME);
                    if (!saved) return null;
                    
                    const gameData = JSON.parse(saved);
                    // Convert conflicts array back to Set
                    if (gameData.conflicts) {
                        gameData.conflicts = new Set(gameData.conflicts);
                    }
                    return gameData;
                } catch (e) {
                    console.error('Error loading game:', e);
                    return null;
                }
            },

            // Clear saved game
            clearSavedGame: () => {
                try {
                    localStorage.removeItem(STORAGE_KEYS.SAVED_GAME);
                    return true;
                } catch (e) {
                    console.error('Error clearing saved game:', e);
                    return false;
                }
            },

            // Save settings
            saveSettings: (settings) => {
                try {
                    localStorage.setItem(STORAGE_KEYS.SETTINGS, JSON.stringify(settings));
                    return true;
                } catch (e) {
                    console.error('Error saving settings:', e);
                    return false;
                }
            },

            // Load settings
            loadSettings: () => {
                try {
                    const saved = localStorage.getItem(STORAGE_KEYS.SETTINGS);
                    if (!saved) return null;
                    return JSON.parse(saved);
                } catch (e) {
                    console.error('Error loading settings:', e);
                    return null;
                }
            },

            // Save best times
            saveBestTimes: (times) => {
                try {
                    localStorage.setItem(STORAGE_KEYS.BEST_TIMES, JSON.stringify(times));
                    return true;
                } catch (e) {
                    console.error('Error saving best times:', e);
                    return false;
                }
            },

            // Load best times
            loadBestTimes: () => {
                try {
                    const saved = localStorage.getItem(STORAGE_KEYS.BEST_TIMES);
                    if (!saved) return {};
                    return JSON.parse(saved);
                } catch (e) {
                    console.error('Error loading best times:', e);
                    return {};
                }
            }
        };

        const SudokuGame = () => {
            const [board, setBoard] = useState(Array(9).fill().map(() => Array(9).fill(0)));
            const [initialBoard, setInitialBoard] = useState(Array(9).fill().map(() => Array(9).fill(0)));
            const [selectedCell, setSelectedCell] = useState(null);
            const [difficulty, setDifficulty] = useState('medium');
            const [gameState, setGameState] = useState('menu'); // menu, playing, won
            const [mistakes, setMistakes] = useState(0);
            const [hints, setHints] = useState(3);
            const [timer, setTimer] = useState(0);
            const [isRunning, setIsRunning] = useState(false);
            const [conflicts, setConflicts] = useState(new Set());
            const [highlightedNumber, setHighlightedNumber] = useState(null);
            const [showSettings, setShowSettings] = useState(false);
            const [settings, setSettings] = useState({
                sound: true,
                vibration: true,
                theme: 'blue'
            });
            const [savedGame, setSavedGame] = useState(null);
            const [bestTime, setBestTime] = useState(null);

            // Load initial data from localStorage on component mount
            useEffect(() => {
                // Load settings
                const savedSettings = StorageManager.loadSettings();
                if (savedSettings) {
                    setSettings(savedSettings);
                }

                // Load saved game
                const loadedGame = StorageManager.loadGame();
                if (loadedGame) {
                    setSavedGame(loadedGame);
                }

                // Load best times
                const times = StorageManager.loadBestTimes();
                const timeForDiff = times[difficulty];
                setBestTime(typeof timeForDiff === 'number' ? timeForDiff : null);
            }, []);

            // Save settings whenever they change
            useEffect(() => {
                StorageManager.saveSettings(settings);
            }, [settings]);

            // Load the best time for the current difficulty whenever difficulty changes
            useEffect(() => {
                const times = StorageManager.loadBestTimes();
                const timeForDiff = times[difficulty];
                setBestTime(typeof timeForDiff === 'number' ? timeForDiff : null);
            }, [difficulty]);

            // Timer effect
            useEffect(() => {
                let interval;
                if (isRunning && gameState === 'playing') {
                    interval = setInterval(() => setTimer(timer => timer + 1), 1000);
                }
                return () => clearInterval(interval);
            }, [isRunning, gameState]);

            // Auto-save game state whenever it changes during gameplay
            useEffect(() => {
                if (gameState === 'playing') {
                    const gameData = {
                        board,
                        initialBoard,
                        difficulty,
                        mistakes,
                        hints,
                        timer,
                        conflicts,
                        highlightedNumber,
                        selectedCell
                    };
                    
                    // Save to localStorage
                    StorageManager.saveGame(gameData);
                    // Also keep in memory for immediate access
                    setSavedGame(gameData);
                }
            }, [board, initialBoard, difficulty, mistakes, hints, timer, conflicts, highlightedNumber, selectedCell, gameState]);

            // Clear saved game when game is won or when starting a new game
            useEffect(() => {
                if (gameState === 'won' ) { //|| gameState === 'menu'
                    StorageManager.clearSavedGame();
                    setSavedGame(null);
                }
            }, [gameState]);

            // Sound and vibration functions
            const playSound = (type) => {
                if (!settings.sound) return;
                
                try {
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    const frequencies = {
                        place: 800,
                        error: 200,
                        win: 1000,
                        hint: 600
                    };
                    
                    oscillator.frequency.value = frequencies[type] || 400;
                    oscillator.type = 'sine';
                    
                    gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
                    
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.1);
                } catch (e) {
                    console.log('Audio not supported');
                }
            };

            const vibrate = (pattern = [100]) => {
                if (settings.vibration && navigator.vibrate) {
                    navigator.vibrate(pattern);
                }
            };

            // Theme configurations
            const themes = {
                blue: {
                    gradient: 'from-indigo-600 via-purple-600 to-pink-600',
                    primary: 'bg-blue-500 hover:bg-blue-600',
                    secondary: 'bg-blue-100',
                    selected: 'bg-blue-400',
                    highlight: 'bg-green-200 text-green-800',
                    conflict: 'bg-red-200 text-red-800'
                },
                purple: {
                    gradient: 'from-purple-600 via-pink-600 to-red-600',
                    primary: 'bg-purple-500 hover:bg-purple-600',
                    secondary: 'bg-purple-100',
                    selected: 'bg-purple-400',
                    highlight: 'bg-yellow-200 text-yellow-800',
                    conflict: 'bg-red-200 text-red-800'
                }
            };

            const currentTheme = themes[settings.theme];

            // Format timer display
            const formatTime = (seconds) => {
                const mins = Math.floor(seconds / 60);
                const secs = seconds % 60;
                return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            };

            // Generate a complete valid Sudoku board
            const generateCompleteBoard = () => {
                const board = Array(9).fill().map(() => Array(9).fill(0));
                
                const isValid = (board, row, col, num) => {
                    // Check row
                    for (let x = 0; x < 9; x++) {
                        if (board[row][x] === num) return false;
                    }
                    
                    // Check column
                    for (let x = 0; x < 9; x++) {
                        if (board[x][col] === num) return false;
                    }
                    
                    // Check 3x3 box
                    const startRow = row - row % 3;
                    const startCol = col - col % 3;
                    for (let i = 0; i < 3; i++) {
                        for (let j = 0; j < 3; j++) {
                            if (board[i + startRow][j + startCol] === num) return false;
                        }
                    }
                    
                    return true;
                };

                const solve = (board) => {
                    for (let row = 0; row < 9; row++) {
                        for (let col = 0; col < 9; col++) {
                            if (board[row][col] === 0) {
                                const numbers = [1, 2, 3, 4, 5, 6, 7, 8, 9].sort(() => Math.random() - 0.5);
                                for (let num of numbers) {
                                    if (isValid(board, row, col, num)) {
                                        board[row][col] = num;
                                        if (solve(board)) return true;
                                        board[row][col] = 0;
                                    }
                                }
                                return false;
                            }
                        }
                    }
                    return true;
                };

                solve(board);
                return board;
            };

            // Remove numbers to create puzzle
            const createPuzzle = (completeBoard, difficulty) => {
                const puzzle = completeBoard.map(row => [...row]);
                const difficultySettings = {
                    easy:35,
                    medium: 40,
                    hard: 50,
                    expert: 60
                };
                
                const cellsToRemove = difficultySettings[difficulty];
                let removed = 0;
                
                while (removed < cellsToRemove) {
                    const row = Math.floor(Math.random() * 9);
                    const col = Math.floor(Math.random() * 9);
                    
                    if (puzzle[row][col] !== 0) {
                        puzzle[row][col] = 0;
                        removed++;
                    }
                }
                
                return puzzle;
            };

            // Start new game
            const startNewGame = (selectedDifficulty) => {
                
                // Explicitly clear any old game before starting a new one
                StorageManager.clearSavedGame();
                setSavedGame(null);

                const completeBoard = generateCompleteBoard();
                const puzzleBoard = createPuzzle(completeBoard, selectedDifficulty);
                
                setBoard(puzzleBoard);
                setInitialBoard(puzzleBoard.map(row => [...row]));
                setSelectedCell(null);
                setDifficulty(selectedDifficulty);
                setGameState('playing');
                setMistakes(0);
                setHints(3);
                setTimer(0);
                setIsRunning(true);
                setConflicts(new Set());
                setHighlightedNumber(null);
            };

            // Resume game from saved state
            const resumeGame = () => {
                const gameToResume = savedGame || StorageManager.loadGame();
                if (!gameToResume) return;
                
                setBoard(gameToResume.board);
                setInitialBoard(gameToResume.initialBoard);
                setDifficulty(gameToResume.difficulty);
                setMistakes(gameToResume.mistakes);
                setHints(gameToResume.hints);
                setTimer(gameToResume.timer);
                setConflicts(gameToResume.conflicts || new Set());
                setHighlightedNumber(gameToResume.highlightedNumber);
                setSelectedCell(gameToResume.selectedCell || null);
                setGameState('playing');
                setIsRunning(true);
            };

            // Delete saved game
            const deleteSavedGame = () => {
                StorageManager.clearSavedGame();
                setSavedGame(null);
            };

            // Check for conflicts
            const checkConflicts = (board) => {
                const conflicts = new Set();
                
                for (let row = 0; row < 9; row++) {
                    for (let col = 0; col < 9; col++) {
                        if (board[row][col] !== 0) {
                            // Check row conflicts
                            for (let c = 0; c < 9; c++) {
                                if (c !== col && board[row][c] === board[row][col]) {
                                    conflicts.add(`${row}-${col}`);
                                    conflicts.add(`${row}-${c}`);
                                }
                            }
                            
                            // Check column conflicts
                            for (let r = 0; r < 9; r++) {
                                if (r !== row && board[r][col] === board[row][col]) {
                                    conflicts.add(`${row}-${col}`);
                                    conflicts.add(`${r}-${col}`);
                                }
                            }
                            
                            // Check box conflicts
                            const startRow = Math.floor(row / 3) * 3;
                            const startCol = Math.floor(col / 3) * 3;
                            for (let r = startRow; r < startRow + 3; r++) {
                                for (let c = startCol; c < startCol + 3; c++) {
                                    if ((r !== row || c !== col) && board[r][c] === board[row][col]) {
                                        conflicts.add(`${row}-${col}`);
                                        conflicts.add(`${r}-${c}`);
                                    }
                                }
                            }
                        }
                    }
                }
                
                return conflicts;
            };

            // Check if puzzle is complete
            const isPuzzleComplete = (board) => {
                for (let row = 0; row < 9; row++) {
                    for (let col = 0; col < 9; col++) {
                        if (board[row][col] === 0) return false;
                    }
                }
                return checkConflicts(board).size === 0;
            };

            // Handle cell input
            const handleCellInput = (row, col, value) => {
                if (initialBoard[row][col] !== 0) return; // Can't modify initial numbers
                
                const newBoard = board.map(r => [...r]);
                const oldValue = newBoard[row][col];
                newBoard[row][col] = value;
                
                const newConflicts = checkConflicts(newBoard);
                
                // Check if this creates a mistake
                if (value !== 0 && newConflicts.has(`${row}-${col}`)) {
                    if (oldValue === 0) { // Only count as mistake if it's a new entry
                        setMistakes(m => m + 1);
                        playSound('error');
                        vibrate([200]);
                    }
                } else if (value !== 0) {
                    playSound('place');
                    vibrate([50]);
                }
                
                setBoard(newBoard);
                setConflicts(newConflicts);
                
                // Set highlighted number
                setHighlightedNumber(value === 0 ? null : value);
                
                // Check for win condition
                if (isPuzzleComplete(newBoard)) {
                    setGameState('won');
                    setIsRunning(false);
                    playSound('win');
                    vibrate([100, 50, 100, 50, 200]);
                    
                    // Update best time if this is the fastest solve for the current difficulty
                    const times = StorageManager.loadBestTimes();
                    const currentBest = times[difficulty];
                    if (typeof currentBest !== 'number' || timer < currentBest) {
                        times[difficulty] = timer;
                        StorageManager.saveBestTimes(times);
                        setBestTime(timer);
                    }
                }
            };

            // Use hint
            const useHint = () => {
                if (hints <= 0) return;
                
                // Find an empty cell that has only one possible valid value
                for (let row = 0; row < 9; row++) {
                    for (let col = 0; col < 9; col++) {
                        if (board[row][col] === 0) {
                            const possibleValues = [];
                            
                            for (let num = 1; num <= 9; num++) {
                                // Check if this number would be valid in this position
                                let isValid = true;
                                
                                // Check row
                                for (let c = 0; c < 9; c++) {
                                    if (board[row][c] === num) {
                                        isValid = false;
                                        break;
                                    }
                                }
                                
                                // Check column
                                if (isValid) {
                                    for (let r = 0; r < 9; r++) {
                                        if (board[r][col] === num) {
                                            isValid = false;
                                            break;
                                        }
                                    }
                                }
                                
                                // Check 3x3 box
                                if (isValid) {
                                    const startRow = Math.floor(row / 3) * 3;
                                    const startCol = Math.floor(col / 3) * 3;
                                    for (let r = startRow; r < startRow + 3; r++) {
                                        for (let c = startCol; c < startCol + 3; c++) {
                                            if (board[r][c] === num) {
                                                isValid = false;
                                                break;
                                            }
                                        }
                                        if (!isValid) break;
                                    }
                                }
                                
                                if (isValid) {
                                    possibleValues.push(num);
                                }
                            }
                            
                            // If only one possible value, use it as hint
                            if (possibleValues.length === 1) {
                                const newBoard = board.map(r => [...r]);
                                newBoard[row][col] = possibleValues[0];
                                setBoard(newBoard);
                                setHints(h => h - 1);
                                setHighlightedNumber(possibleValues[0]);
                                playSound('hint');
                                vibrate([100]);
                                
                                // Check for win condition
                                if (isPuzzleComplete(newBoard)) {
                                    setGameState('won');
                                    setIsRunning(false);
                                    playSound('win');
                                    vibrate([100, 50, 100, 50, 200]);
                                }
                                return;
                            }
                        }
                    }
                }
                
                // If no obvious hints, just fill the first empty cell with a valid number
                for (let row = 0; row < 9; row++) {
                    for (let col = 0; col < 9; col++) {
                        if (board[row][col] === 0) {
                            for (let num = 1; num <= 9; num++) {
                                let isValid = true;
                                
                                // Check row, column, and box
                                for (let c = 0; c < 9; c++) {
                                    if (board[row][c] === num) isValid = false;
                                }
                                for (let r = 0; r < 9; r++) {
                                    if (board[r][col] === num) isValid = false;
                                }
                                const startRow = Math.floor(row / 3) * 3;
                                const startCol = Math.floor(col / 3) * 3;
                                for (let r = startRow; r < startRow + 3; r++) {
                                    for (let c = startCol; c < startCol + 3; c++) {
                                        if (board[r][c] === num) isValid = false;
                                    }
                                }
                                
                                if (isValid) {
                                    const newBoard = board.map(r => [...r]);
                                    newBoard[row][col] = num;
                                    setBoard(newBoard);
                                    setHints(h => h - 1);
                                    setHighlightedNumber(num);
                                    playSound('hint');
                                    vibrate([100]);
                                    return;
                                }
                            }
                        }
                    }
                }
            };

            // Reset game
            const resetGame = () => {
                setBoard(initialBoard.map(row => [...row]));
                setSelectedCell(null);
                setMistakes(0);
                setTimer(0);
                setIsRunning(true);
                setConflicts(new Set());
                setHighlightedNumber(null);
            };

            // Settings handlers
            const handleOpenSettings = useCallback(() => {
                setShowSettings(true);
            }, []);

            const handleCloseSettings = useCallback(() => {
                setShowSettings(false);
            }, []);

            const handleThemeChange = (theme) => {
                setSettings(prev => ({ ...prev, theme }));
            };

            const handleSoundToggle = () => {
                setSettings(prev => ({ ...prev, sound: !prev.sound }));
            };

            const handleVibrationToggle = () => {
                setSettings(prev => ({ ...prev, vibration: !prev.vibration }));
            };

            // Number input buttons
            const renderNumberButtons = () => (
                <div className="grid grid-cols-5 gap-2 mb-4">
                    <button
                        onClick={() => {
                            if (selectedCell) {
                                handleCellInput(selectedCell.row, selectedCell.col, 0);
                            }
                        }}
                        className="bg-red-500 hover:bg-red-600 text-white p-3 rounded-lg font-bold transition-colors"
                    >
                        ✕
                    </button>
                    {[1, 2, 3, 4, 5, 6, 7, 8, 9].map(num => (
                        <button
                            key={num}
                            onClick={() => {
                                if (selectedCell) {
                                    handleCellInput(selectedCell.row, selectedCell.col, num);
                                } else {
                                    setHighlightedNumber(highlightedNumber === num ? null : num);
                                }
                            }}
                            className={`
                                p-3 rounded-lg font-bold transition-colors
                                ${highlightedNumber === num 
                                    ? `${currentTheme.primary.replace('hover:bg-', 'bg-').split(' ')[0]} ${currentTheme.primary.split(' ')[1]} text-white ring-2 ring-opacity-50` 
                                    : currentTheme.primary + ' text-white'
                                }
                            `}
                        >
                            {num}
                        </button>
                    ))}
                </div>
            );

            // Calculate how long ago the game was saved
            const getTimeSinceSaved = (savedAt) => {
                if (!savedAt) return '';
                const now = Date.now();
                const diff = now - savedAt;
                const minutes = Math.floor(diff / 60000);
                const hours = Math.floor(minutes / 60);
                const days = Math.floor(hours / 24);
                
                if (days > 0) return `${days} day${days > 1 ? 's' : ''} ago`;
                if (hours > 0) return `${hours} hour${hours > 1 ? 's' : ''} ago`;
                if (minutes > 0) return `${minutes} minute${minutes > 1 ? 's' : ''} ago`;
                return 'Just now';
            };

            if (gameState === 'menu') {
                return (
                    <div className={`min-h-screen bg-gradient-to-br ${currentTheme.gradient} flex items-center justify-center p-4`}>
                        <div className="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full">
                            <div className="text-center mb-8">
                                <h1 className="text-4xl font-bold text-gray-800 mb-2">Sudoku Master</h1>
                                <p className="text-gray-600">Challenge your mind with classic Sudoku</p>
                            </div>
                            
                            {/* Resume Game Button */}
                            {(savedGame || StorageManager.loadGame()) && (
                                <div className="mb-6">
                                    <div className="bg-green-50 border border-green-200 rounded-xl p-4 mb-3">
                                        <div className="flex items-center justify-between">
                                            <div className="text-left">
                                                <div className="font-bold text-green-800">Saved Game Available</div>
                                                <div className="text-sm text-green-600">
                                                    {savedGame?.difficulty || StorageManager.loadGame()?.difficulty} difficulty • {formatTime(savedGame?.timer || StorageManager.loadGame()?.timer || 0)}
                                                </div>
                                                <div className="text-xs text-green-500 mt-1">
                                                    Saved {getTimeSinceSaved(savedGame?.savedAt || StorageManager.loadGame()?.savedAt)}
                                                </div>
                                            </div>
                                            <button
                                                onClick={deleteSavedGame}
                                                className="p-2 text-red-500 hover:text-red-700 hover:bg-red-50 rounded-lg transition-colors"
                                                title="Delete saved game"
                                            >
                                                <Trash2 size={16} />
                                            </button>
                                        </div>
                                    </div>
                                    <button
                                        onClick={resumeGame}
                                        className="w-full bg-green-500 hover:bg-green-600 text-white p-4 rounded-xl font-semibold transition-colors flex items-center justify-center"
                                    >
                                        <Play size={24} className="mr-2" />
                                        Resume Game
                                    </button>
                                </div>
                            )}
                            
                            <div className="space-y-4">
                                <h2 className="text-xl font-semibold text-gray-700 text-center">New Game</h2>
                                
                                {[
                                    { level: 'easy', label: 'Easy', desc: 'Perfect for beginners', color: 'bg-green-500 hover:bg-green-600' },
                                    { level: 'medium', label: 'Medium', desc: 'Balanced challenge', color: 'bg-yellow-500 hover:bg-yellow-600' },
                                    { level: 'hard', label: 'Hard', desc: 'For puzzle masters', color: 'bg-red-500 hover:bg-red-600' },
                                    { level: 'expert', label: 'Expert', desc: 'A true test of skill', color: 'bg-purple-500 hover:bg-purple-600' }
                                ].map(({ level, label, desc, color }) => {
                                    const levelBestTime = StorageManager.loadBestTimes()[level];
                                    return (
                                        <button
                                            key={level}
                                            onClick={() => startNewGame(level)}
                                            className={`w-full ${color} text-white p-4 rounded-xl font-semibold transition-colors`}
                                        >
                                            <div className="flex items-center justify-between">
                                                <div className="text-left">
                                                    <div className="font-bold">{label}</div>
                                                    <div className="text-sm opacity-90">{desc}</div>
                                                    {levelBestTime && (
                                                        <div className="text-xs opacity-75 mt-1">
                                                            Best: {formatTime(levelBestTime)}
                                                        </div>
                                                    )}
                                                </div>
                                                <Play size={24} />
                                            </div>
                                        </button>
                                    );
                                })}
                            </div>
                            
                            {/* Settings Button */}
                            <div className="mt-6">
                                <button
                                    onClick={handleOpenSettings}
                                    className="w-full bg-gray-500 hover:bg-gray-600 text-white p-3 rounded-xl font-semibold transition-colors flex items-center justify-center"
                                >
                                    <Settings size={20} className="mr-2" />
                                    Settings
                                </button>
                            </div>
                        </div>
                        
                        {/* Settings Modal */}
                        {showSettings && (
                            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                                <div className="bg-white rounded-2xl shadow-2xl p-6 max-w-sm w-full">
                                    <h2 className="text-2xl font-bold text-gray-800 mb-6 text-center">Settings</h2>
                                    
                                    <div className="space-y-6">
                                        {/* Theme Selection */}
                                        <div>
                                            <h3 className="text-lg font-semibold text-gray-700 mb-3 flex items-center">
                                                <Palette size={20} className="mr-2" />
                                                Theme
                                            </h3>
                                            <div className="grid grid-cols-2 gap-3">
                                                {Object.entries(themes).map(([key, theme]) => (
                                                    <button
                                                        key={key}
                                                        onClick={() => handleThemeChange(key)}
                                                        className={`
                                                            p-4 rounded-xl font-semibold transition-colors capitalize
                                                            ${settings.theme === key 
                                                                ? `${theme.primary} text-white ring-2 ring-opacity-50` 
                                                                : 'bg-gray-100 hover:bg-gray-200 text-gray-700'
                                                            }
                                                        `}
                                                    >
                                                        {key}
                                                    </button>
                                                ))}
                                            </div>
                                        </div>

                                        {/* Sound Toggle */}
                                        <div>
                                            <h3 className="text-lg font-semibold text-gray-700 mb-3 flex items-center">
                                                {settings.sound ? <Volume2 size={20} className="mr-2" /> : <VolumeX size={20} className="mr-2" />}
                                                Sound Effects
                                            </h3>
                                            <button
                                                onClick={handleSoundToggle}
                                                className={`
                                                    w-full p-3 rounded-xl font-semibold transition-colors
                                                    ${settings.sound 
                                                        ? 'bg-green-500 hover:bg-green-600 text-white' 
                                                        : 'bg-gray-300 hover:bg-gray-400 text-gray-700'
                                                    }
                                                `}
                                            >
                                                {settings.sound ? 'Enabled' : 'Disabled'}
                                            </button>
                                        </div>

                                        {/* Vibration Toggle */}
                                        <div>
                                            <h3 className="text-lg font-semibold text-gray-700 mb-3 flex items-center">
                                                <Smartphone size={20} className="mr-2" />
                                                Vibration
                                            </h3>
                                            <button
                                                onClick={handleVibrationToggle}
                                                className={`
                                                    w-full p-3 rounded-xl font-semibold transition-colors
                                                    ${settings.vibration 
                                                        ? 'bg-green-500 hover:bg-green-600 text-white' 
                                                        : 'bg-gray-300 hover:bg-gray-400 text-gray-700'
                                                    }
                                                `}
                                            >
                                                {settings.vibration ? 'Enabled' : 'Disabled'}
                                            </button>
                                        </div>
                                    </div>

                                    {/* Close Button */}
                                    <button
                                        onClick={handleCloseSettings}
                                        className="w-full mt-6 bg-gray-500 hover:bg-gray-600 text-white p-3 rounded-xl font-semibold transition-colors"
                                    >
                                        Close
                                    </button>
                                </div>
                            </div>
                        )}
                    </div>
                );
            }

            if (gameState === 'won') {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-yellow-400 via-orange-500 to-red-500 flex items-center justify-center p-4">
                        <div className="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full text-center">
                            <Trophy className="mx-auto mb-4 text-yellow-500" size={64} />
                            <h1 className="text-3xl font-bold text-gray-800 mb-4">Congratulations!</h1>
                            <p className="text-gray-600 mb-6">You solved the puzzle!</p>
                            
                            <div className="bg-gray-100 rounded-xl p-4 mb-6">
                                <div className="grid grid-cols-2 gap-4 text-center">
                                    <div>
                                        <Clock className="mx-auto mb-2 text-blue-500" size={24} />
                                        <div className="font-bold text-lg">{formatTime(timer)}</div>
                                        <div className="text-sm text-gray-600">Time</div>
                                        {bestTime === timer && (
                                            <div className="text-xs text-green-600 font-semibold mt-1">New Record! 🎉</div>
                                        )}
                                    </div>
                                    <div>
                                        <Star className="mx-auto mb-2 text-red-500" size={24} />
                                        <div className="font-bold text-lg">{mistakes}</div>
                                        <div className="text-sm text-gray-600">Mistakes</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div className="space-y-3">
                                <button
                                    onClick={() => startNewGame(difficulty)}
                                    className="w-full bg-blue-500 hover:bg-blue-600 text-white p-3 rounded-xl font-semibold transition-colors"
                                >
                                    Play Again
                                </button>
                                <button
                                    onClick={() => setGameState('menu')}
                                    className="w-full bg-gray-500 hover:bg-gray-600 text-white p-3 rounded-xl font-semibold transition-colors"
                                >
                                    Main Menu
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className={`min-h-screen bg-gradient-to-br ${currentTheme.gradient} p-4`}>
                    <div className="max-w-md mx-auto">
                        {/* Header */}
                        <div className="bg-white rounded-xl shadow-lg p-4 mb-4">
                            <div className="flex justify-between items-center mb-3">
                                <div className="flex items-center space-x-3">
                                    <div className="text-lg font-bold text-gray-800 capitalize">{difficulty}</div>
                                    <button
                                        onClick={handleOpenSettings}
                                        className="p-2 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors border border-gray-300 min-w-[40px] min-h-[40px] flex items-center justify-center"
                                    >
                                        <Settings size={20} className="text-gray-600" />
                                    </button>
                                </div>
                                <div className="text-lg font-bold text-blue-600">{formatTime(timer)}</div>
                            </div>
                            
                            <div className="flex justify-between text-sm space-x-2">
                                <div className="flex items-center">
                                    <Star className="mr-1 text-red-500" size={16} />
                                    <span>Mistakes: {mistakes}</span>
                                </div>
                                <div className="flex items-center">
                                    <Lightbulb className="mr-1 text-yellow-500" size={16} />
                                    <span>Hints: {hints}</span>
                                </div>
                                <div className="flex items-center">
                                    <Clock className="mr-1 text-green-500" size={16} />
                                    <span>Best: {bestTime !== null ? formatTime(bestTime) : '--:--'}</span>
                                </div>
                            </div>
                        </div>

                        {/* Game Board */}
                        <div className="bg-white rounded-xl shadow-lg p-4 mb-4 sudoku-board">
                            <div className="bg-gray-800 p-3 rounded-lg">
                                <div className="grid grid-cols-3 gap-2">
                                    {[0, 1, 2].map(blockRow => (
                                        [0, 1, 2].map(blockCol => (
                                            <div key={`block-${blockRow}-${blockCol}`} className="bg-gray-600 p-1 rounded">
                                                <div className="grid grid-cols-3 gap-1">
                                                    {[0, 1, 2].map(cellRow => (
                                                        [0, 1, 2].map(cellCol => {
                                                            const rowIndex = blockRow * 3 + cellRow;
                                                            const colIndex = blockCol * 3 + cellCol;
                                                            const cell = board[rowIndex][colIndex];
                                                            
                                                            const isSelected = selectedCell?.row === rowIndex && selectedCell?.col === colIndex;
                                                            const isInitial = initialBoard[rowIndex][colIndex] !== 0;
                                                            const hasConflict = conflicts.has(`${rowIndex}-${colIndex}`);
                                                            const isInSameRow = selectedCell?.row === rowIndex;
                                                            const isInSameCol = selectedCell?.col === colIndex;
                                                            const isInSameBox = selectedCell && 
                                                                Math.floor(selectedCell.row / 3) === Math.floor(rowIndex / 3) &&
                                                                Math.floor(selectedCell.col / 3) === Math.floor(colIndex / 3);
                                                            const isHighlightedNumber = highlightedNumber && cell === highlightedNumber;

                                                            return (
                                                                <button
                                                                    key={`${rowIndex}-${colIndex}`}
                                                                    onClick={() => {
                                                                        setSelectedCell({ row: rowIndex, col: colIndex });
                                                                        setHighlightedNumber(cell === 0 ? null : cell);
                                                                    }}
                                                                    className={`
                                                                        aspect-square flex items-center justify-center text-lg font-bold rounded
                                                                        ${isSelected ? `${currentTheme.selected} text-white` : 
                                                                          hasConflict ? currentTheme.conflict :
                                                                          isHighlightedNumber ? currentTheme.highlight :
                                                                          isInSameRow || isInSameCol || isInSameBox ? currentTheme.secondary :
                                                                          'bg-white hover:bg-gray-100'}
                                                                        ${isInitial ? 'text-gray-800 font-black' : 'text-blue-600'}
                                                                        ${isHighlightedNumber && !hasConflict ? 'ring-2 ring-green-400' : ''}
                                                                        transition-all duration-200
                                                                    `}
                                                                >
                                                                    {cell !== 0 ? cell : ''}
                                                                </button>
                                                            );
                                                        })
                                                    ))}
                                                </div>
                                            </div>
                                        ))
                                    ))}
                                </div>
                            </div>
                        </div>

                        {/* Number Input */}
                        <div className="bg-white rounded-xl shadow-lg p-4 mb-4">
                            {renderNumberButtons()}
                        </div>

                        {/* Action Buttons */}
                        <div className="bg-white rounded-xl shadow-lg p-4">
                            <div className="grid grid-cols-3 gap-3">
                                <button
                                    onClick={useHint}
                                    disabled={hints <= 0}
                                    className="bg-yellow-500 hover:bg-yellow-600 disabled:bg-gray-300 disabled:cursor-not-allowed text-white p-3 rounded-lg font-semibold flex items-center justify-center transition-colors"
                                >
                                    <Lightbulb size={20} className="mr-1" />
                                    Hint
                                </button>
                                
                                <button
                                    onClick={resetGame}
                                    className="bg-orange-500 hover:bg-orange-600 text-white p-3 rounded-lg font-semibold flex items-center justify-center transition-colors"
                                >
                                    <RotateCcw size={20} className="mr-1" />
                                    Reset
                                </button>
                                
                                <button
                                    onClick={() => setGameState('menu')}
                                    className="bg-gray-500 hover:bg-gray-600 text-white p-3 rounded-lg font-semibold transition-colors"
                                >
                                    Menu
                                </button>
                            </div>
                        </div>

                        {/* Settings Modal */}
                        {showSettings && (
                            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                                <div className="bg-white rounded-2xl shadow-2xl p-6 max-w-sm w-full">
                                    <h2 className="text-2xl font-bold text-gray-800 mb-6 text-center">Settings</h2>
                                    
                                    <div className="space-y-6">
                                        {/* Theme Selection */}
                                        <div>
                                            <h3 className="text-lg font-semibold text-gray-700 mb-3 flex items-center">
                                                <Palette size={20} className="mr-2" />
                                                Theme
                                            </h3>
                                            <div className="grid grid-cols-2 gap-3">
                                                {Object.entries(themes).map(([key, theme]) => (
                                                    <button
                                                        key={key}
                                                        onClick={() => handleThemeChange(key)}
                                                        className={`
                                                            p-4 rounded-xl font-semibold transition-colors capitalize
                                                            ${settings.theme === key 
                                                                ? `${theme.primary} text-white ring-2 ring-opacity-50` 
                                                                : 'bg-gray-100 hover:bg-gray-200 text-gray-700'
                                                            }
                                                        `}
                                                    >
                                                        {key}
                                                    </button>
                                                ))}
                                            </div>
                                        </div>

                                        {/* Sound Toggle */}
                                        <div>
                                            <h3 className="text-lg font-semibold text-gray-700 mb-3 flex items-center">
                                                {settings.sound ? <Volume2 size={20} className="mr-2" /> : <VolumeX size={20} className="mr-2" />}
                                                Sound Effects
                                            </h3>
                                            <button
                                                onClick={handleSoundToggle}
                                                className={`
                                                    w-full p-3 rounded-xl font-semibold transition-colors
                                                    ${settings.sound 
                                                        ? 'bg-green-500 hover:bg-green-600 text-white' 
                                                        : 'bg-gray-300 hover:bg-gray-400 text-gray-700'
                                                    }
                                                `}
                                            >
                                                {settings.sound ? 'Enabled' : 'Disabled'}
                                            </button>
                                        </div>

                                        {/* Vibration Toggle */}
                                        <div>
                                            <h3 className="text-lg font-semibold text-gray-700 mb-3 flex items-center">
                                                <Smartphone size={20} className="mr-2" />
                                                Vibration
                                            </h3>
                                            <button
                                                onClick={handleVibrationToggle}
                                                className={`
                                                    w-full p-3 rounded-xl font-semibold transition-colors
                                                    ${settings.vibration 
                                                        ? 'bg-green-500 hover:bg-green-600 text-white' 
                                                        : 'bg-gray-300 hover:bg-gray-400 text-gray-700'
                                                    }
                                                `}
                                            >
                                                {settings.vibration ? 'Enabled' : 'Disabled'}
                                            </button>
                                        </div>
                                    </div>

                                    {/* Close Button */}
                                    <button
                                        onClick={handleCloseSettings}
                                        className="w-full mt-6 bg-gray-500 hover:bg-gray-600 text-white p-3 rounded-xl font-semibold transition-colors"
                                    >
                                        Close
                                    </button>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // Render the app
        ReactDOM.render(<SudokuGame />, document.getElementById('root'));
    </script>
</body>
</html>
                                    